/*
 * Copyright 2022 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package gradlebuild.cleanup

import spock.lang.Specification

class KillLeakingJavaProcessesTest extends Specification {
    String unixPsOutput = """
576321 /opt/files/jdk-linux/OpenJDK11U-jdk_x64_linux_hotspot_11.0.15_10.tar.gz/bin/java -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError --add-opens=java.base/java.util=ALL-UNNAMED --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.lang.invoke=ALL-UNNAMED --add-opens=java.prefs/java.util.prefs=ALL-UNNAMED --add-opens=java.base/java.nio.charset=ALL-UNNAMED --add-opens=java.base/java.net=ALL-UNNAMED --add-opens=java.base/java.util.concurrent.atomic=ALL-UNNAMED -Xmx2500m -Dfile.encoding=UTF-8 -Djava.io.tmpdir=/home/tcagent1/agent/temp/buildTmp -Duser.country=US -Duser.language=en -Duser.variant -cp /home/tcagent1/.gradle/wrapper/dists/gradle-7.6-20220806221607+0000-bin/bahzw6xytyvv1efgmigua9ttp/gradle-7.6-20220806221607+0000/lib/gradle-launcher-7.6.jar org.gradle.launcher.daemon.bootstrap.GradleDaemon 7.6-20220806221607+0000
591686 /opt/files/jdk-linux/OpenJDK11U-jdk_x64_linux_hotspot_11.0.15_10.tar.gz/bin/java --add-opens=java.base/java.util=ALL-UNNAMED --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.lang.invoke=ALL-UNNAMED --add-opens=java.prefs/java.util.prefs=ALL-UNNAMED --add-opens=java.base/java.nio.charset=ALL-UNNAMED --add-opens=java.base/java.net=ALL-UNNAMED --add-opens=java.base/java.util.concurrent.atomic=ALL-UNNAMED -Xmx3g -Dfile.encoding=UTF-8 -Djava.io.tmpdir=/home/tcagent1/agent/temp/buildTmp -Duser.country=US -Duser.language=en -Duser.variant -cp /home/tcagent1/.gradle/wrapper/dists/gradle-7.6-20220727112213+0000-bin/ogbl2n2fcv4m7e8tuoxs96sx/gradle-7.6-20220727112213+0000/lib/gradle-launcher-7.6.jar org.gradle.launcher.daemon.bootstrap.GradleDaemon 7.6-20220727112213+0000
841959 /opt/files/jdk-linux/jdk-8u301-linux-x64.tar.gz/bin/java -Xmx64m -Xms64m -Duser.language=en -Duser.country=US -Dfile.encoding=UTF-8 -Dscan.value.CI Build Type=PluginsPortal_Portal_PluginResolutionProduction -Djava.io.tmpdir=/home/tcagent1/agent/temp/buildTmp -Dorg.gradle.appname=gradlew -classpath /home/tcagent1/agent/work/469d486140ba335/gradle/wrapper/gradle-wrapper.jar org.gradle.wrapper.GradleWrapperMain --init-script /home/tcagent1/agent/plugins/gradle-runner/scripts/init.gradle --init-script /home/tcagent1/agent/temp/agentTmp/build-scan-init.gradle --daemon -PgradlehubAddress=https://plugins.gradle.org -Pgradle.download.specific.version= -s :gradle-test:crossVersionIntegTests
842155 /opt/files/jdk-linux/jdk-8u301-linux-x64.tar.gz/bin/java -Dgradlehub.address=https://plugins.gradle.org -Djava.security.manager=worker.org.gradle.process.internal.worker.child.BootstrapSecurityManager -Dorg.gradle.native=false -Dplugin.version=1.1.0 -Ds3.access-key-id=AKIAZALT2VU7C5VBGEV6 -Ds3.bucket-name=plugins-artifacts-ci.grdev.net -Ds3.secret-access-key=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 -Duse.staged.gradlehub=true -Dwebdriver.chrome.driver=/home/tcagent1/agent/work/469d486140ba335/build/webdriver/chromedriver -Xmx512m -Dfile.encoding=UTF-8 -Djava.io.tmpdir=/home/tcagent1/agent/temp/buildTmp -Duser.country=US -Duser.language=en -Duser.variant -ea -cp /home/tcagent1/.gradle/caches/6.9.2/workerMain/gradle-worker.jar worker.org.gradle.process.internal.worker.GradleWorkerMain 'Gradle Test Executor 2'
843896 grep --color=auto java
1682545 /opt/jdk/open-jdk-11/bin/java -ea -Xms16m -Xmx64m -cp ../launcher/lib/launcher.jar jetbrains.buildServer.agent.Launcher -ea -Xmx384m -Dteamcity_logs=../logs/ jetbrains.buildServer.agent.AgentMain -file ../conf/buildAgent.properties
1682568 /opt/files/jdk-linux/OpenJDK11U-jdk_x64_linux_hotspot_11.0.15_10.tar.gz/bin/java -ea -Xmx384m -Dteamcity_logs=../logs/ -classpath /home/tcagent1/agent/lib/jdom.jar:/home/tcagent1/agent/lib/launcher.jar:/home/tcagent1/agent/lib/server-logging.jar:/home/tcagent1/agent/lib/jakarta.xml.bind-api.jar:/home/tcagent1/agent/lib/agent-installer-ui.jar:/home/tcagent1/agent/lib/xmlrpc-2.0.1.jar:/home/tcagent1/agent/lib/ehcache-1.7.2.jar:/home/tcagent1/agent/lib/agent-configurator.jar:/home/tcagent1/agent/lib/cloud-shared.jar:/home/tcagent1/agent/lib/woodstox-core.jar:/home/tcagent1/agent/lib/common-runtime.jar:/home/tcagent1/agent/lib/jackson-module-parameter-names.jar:/home/tcagent1/agent/lib/freemarker.jar:/home/tcagent1/agent/lib/joda-time.jar:/home/tcagent1/agent/lib/patches.jar:/home/tcagent1/agent/lib/spring-scripting/spring-scripting-groovy.jar:/home/tcagent1/agent/lib/spring-scripting/spring-scripting-jruby.jar:/home/tcagent1/agent/lib/spring-scripting/spring-scripting-bsh.jar:/home/tcagent1/agent/lib/commons-collections-3.2.2.jar:/home/tcagent1/agent/lib/slf4j-log4j12-1.7.32.jar:/home/tcagent1/agent/lib/jaxen-1.1.1.jar:/home/tcagent1/agent/lib/stax2-api.jar:/home/tcagent1/agent/lib/xml-apis-1.4.01.jar:/home/tcagent1/agent/lib/openapi.jar:/home/tcagent1/agent/lib/commons-codec.jar:/home/tcagent1/agent/lib/jackson-databind.jar:/home/tcagent1/agent/lib/jackson-module-jaxb-annotations.jar:/home/tcagent1/agent/lib/util.jar:/home/tcagent1/agent/lib/agent-openapi.jar:/home/tcagent1/agent/lib/spring.jar:/home/tcagent1/agent/lib/logging.jar:/home/tcagent1/agent/lib/log4j-api-2.17.2.jar:/home/tcagent1/agent/lib/duplicator-util.jar:/home/tcagent1/agent/lib/patches-impl.jar:/home/tcagent1/agent/lib/buildAgent-updates-applying.jar:/home/tcagent1/agent/lib/xz-1.8.jar:/home/tcagent1/agent/lib/common-impl.jar:/home/tcagent1/agent/lib/snakeyaml.jar:/home/tcagent1/agent/lib/jackson-dataformat-xml.jar:/home/tcagent1/agent/lib/jackson-datatype-jsr310.jar:/home/tcagent1/agent/lib/idea-settings.jar:/home/tcagent1/agent/lib/slf4j-api-1.7.32.jar:/home/tcagent1/agent/lib/messages.jar:/home/tcagent1/agent/lib/jdk-searcher.jar:/home/tcagent1/agent/lib/trove-3.0.3.jar:/home/tcagent1/agent/lib/agent.jar:/home/tcagent1/agent/lib/annotations.jar:/home/tcagent1/agent/lib/log4j-core-2.17.2.jar:/home/tcagent1/agent/lib/gson-2.8.9.jar:/home/tcagent1/agent/lib/coverage-agent-common.jar:/home/tcagent1/agent/lib/common.jar:/home/tcagent1/agent/lib/launcher-api.jar:/home/tcagent1/agent/lib/xstream-1.4.11.1-custom.jar:/home/tcagent1/agent/lib/ehcache-1.6.0-patch.jar:/home/tcagent1/agent/lib/jackson-annotations.jar:/home/tcagent1/agent/lib/jackson-dataformat-yaml.jar:/home/tcagent1/agent/lib/commons-io-1.3.2.jar:/home/tcagent1/agent/lib/agent-upgrade.jar:/home/tcagent1/agent/lib/jackson-datatype-jdk8.jar:/home/tcagent1/agent/lib/serviceMessages.jar:/home/tcagent1/agent/lib/coverage-report-1.0.jar:/home/tcagent1/agent/lib/agent-launcher.jar:/home/tcagent1/agent/lib/log4j-1.2.12-json-layout.jar:/home/tcagent1/agent/lib/xercesImpl.jar:/home/tcagent1/agent/lib/oauth-integration-agent.jar:/home/tcagent1/agent/lib/commons-logging.jar:/home/tcagent1/agent/lib/runtime-util.jar:/home/tcagent1/agent/lib/commons-httpclient-3.1.jar:/home/tcagent1/agent/lib/trove4j.jar:/home/tcagent1/agent/lib/commons-beanutils-core.jar:/home/tcagent1/agent/lib/inspections-util.jar:/home/tcagent1/agent/lib/nuget-utils.jar:/home/tcagent1/agent/lib/log4j-1.2-api-2.17.2.jar:/home/tcagent1/agent/lib/app-wrapper.jar:/home/tcagent1/agent/lib/commons-compress-1.21.jar:/home/tcagent1/agent/lib/xml-rpc-wrapper.jar:/home/tcagent1/agent/lib/resources_en.jar:/home/tcagent1/agent/lib/xpp3-1.1.4c.jar:/home/tcagent1/agent/lib/jackson-core.jar jetbrains.buildServer.agent.AgentMain -file ../conf/buildAgent.properties -launcher.version 108706
"""
    String windowsPsOutput = """
C:\\Windows\\system32\\lsass.exe  728

C:\\Windows\\system32\\svchost.exe -k DcomLaunch -p -s PlugPlay  848

"fontdrvhost.exe"  904

C:\\Windows\\system32\\svchost.exe -k RPCSS -p  984

\\??\\C:\\Windows\\system32\\conhost.exe 0x4  2880

"C:\\Program Files\\Java\\open-jdk-11\\bin\\java.exe" -ea -Xmx512m -XX:+HeapDumpOnOutOfMemoryError -Xrs -Dlog4j.configuration=file:../conf/teamcity-agent-log4j.xml -Dteamcity_logs=../logs/ -classpath C:\\tcagent1\\lib\\agent-configurator.jar;C:\\tcagent1\\lib\\agent-installer-ui.jar;C:\\tcagent1\\lib\\agent-launcher.jar;C:\\tcagent1\\lib\\agent-openapi.jar;C:\\tcagent1\\lib\\agent-upgrade.jar;C:\\tcagent1\\lib\\agent.jar;C:\\tcagent1\\lib\\annotations.jar;C:\\tcagent1\\lib\\app-wrapper.jar;C:\\tcagent1\\lib\\buildAgent-updates-applying.jar;C:\\tcagent1\\lib\\cloud-shared.jar;C:\\tcagent1\\lib\\common-impl.jar;C:\\tcagent1\\lib\\common-runtime.jar;C:\\tcagent1\\lib\\common.jar;C:\\tcagent1\\lib\\commons-beanutils-core.jar;C:\\tcagent1\\lib\\commons-codec.jar;C:\\tcagent1\\lib\\commons-collections-3.2.2.jar;C:\\tcagent1\\lib\\commons-compress-1.21.jar;C:\\tcagent1\\lib\\commons-httpclient-3.1.jar;C:\\tcagent1\\lib\\commons-io-1.3.2.jar;C:\\tcagent1\\lib\\commons-logging.jar;C:\\tcagent1\\lib\\coverage-agent-common.jar;C:\\tcagent1\\lib\\coverage-report-1.0.jar;C:\\tcagent1\\lib\\duplicator-util.jar;C:\\tcagent1\\lib\\ehcache-1.6.0-patch.jar;C:\\tcagent1\\lib\\ehcache-1.7.2.jar;C:\\tcagent1\\lib\\freemarker.jar;C:\\tcagent1\\lib\\gson-2.8.9.jar;C:\\tcagent1\\lib\\idea-settings.jar;C:\\tcagent1\\lib\\inspections-util.jar;C:\\tcagent1\\lib\\jackson-annotations.jar;C:\\tcagent1\\lib\\jackson-core.jar;C:\\tcagent1\\lib\\jackson-databind.jar;C:\\tcagent1\\lib\\jackson-dataformat-xml.jar;C:\\tcagent1\\lib\\jackson-dataformat-yaml.jar;C:\\tcagent1\\lib\\jackson-datatype-jdk8.jar;C:\\tcagent1\\lib\\jackson-datatype-jsr310.jar;C:\\tcagent1\\lib\\jackson-module-jaxb-annotations.jar;C:\\tcagent1\\lib\\jackson-module-parameter-names.jar;C:\\tcagent1\\lib\\jakarta.xml.bind-api.jar;C:\\tcagent1\\lib\\jaxen-1.1.1.jar;C:\\tcagent1\\lib\\jdk-searcher.jar;C:\\tcagent1\\lib\\jdom.jar;C:\\tcagent1\\lib\\joda-time.jar;C:\\tcagent1\\lib\\launcher-api.jar;C:\\tcagent1\\lib\\launcher.jar;C:\\tcagent1\\lib\\log4j-1.2-api-2.17.2.jar;C:\\tcagent1\\lib\\log4j-1.2.12-json-layout.jar;C:\\tcagent1\\lib\\log4j-api-2.17.2.jar;C:\\tcagent1\\lib\\log4j-core-2.17.2.jar;C:\\tcagent1\\lib\\logging.jar;C:\\tcagent1\\lib\\messages.jar;C:\\tcagent1\\lib\\nuget-utils.jar;C:\\tcagent1\\lib\\oauth-integration-agent.jar;C:\\tcagent1\\lib\\openapi.jar;C:\\tcagent1\\lib\\patches-impl.jar;C:\\tcagent1\\lib\\patches.jar;C:\\tcagent1\\lib\\resources_en.jar;C:\\tcagent1\\lib\\runtime-util.jar;C:\\tcagent1\\lib\\server-logging.jar;C:\\tcagent1\\lib\\serviceMessages.jar;C:\\tcagent1\\lib\\slf4j-api-1.7.32.jar;C:\\tcagent1\\lib\\slf4j-log4j12-1.7.32.jar;C:\\tcagent1\\lib\\snakeyaml.jar;C:\\tcagent1\\lib\\spring-scripting\\spring-scripting-bsh.jar;C:\\tcagent1\\lib\\spring-scripting\\spring-scripting-groovy.jar;C:\\tcagent1\\lib\\spring-scripting\\spring-scripting-jruby.jar;C:\\tcagent1\\lib\\spring.jar;C:\\tcagent1\\lib\\stax2-api.jar;C:\\tcagent1\\lib\\trove-3.0.3.jar;C:\\tcagent1\\lib\\trove4j.jar;C:\\tcagent1\\lib\\util.jar;C:\\tcagent1\\lib\\woodstox-core.jar;C:\\tcagent1\\lib\\xercesImpl.jar;C:\\tcagent1\\lib\\xml-apis-1.4.01.jar;C:\\tcagent1\\lib\\xml-rpc-wrapper.jar;C:\\tcagent1\\lib\\xmlrpc-2.0.1.jar;C:\\tcagent1\\lib\\xpp3-1.1.4c.jar;C:\\tcagent1\\lib\\xstream-1.4.11.1-custom.jar;C:\\tcagent1\\lib\\xz-1.8.jar jetbrains.buildServer.agent.AgentMain -file ../conf/buildAgent.properties -launcher.version 108706 10124

"C:\\Program Files\\Java\\open-jdk-11\\bin\\java.exe" -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError --add-opens=java.base/java.util=ALL-UNNAMED --add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.lang.invoke=ALL-UNNAMED --add-opens=java.prefs/java.util.prefs=ALL-UNNAMED --add-opens=java.base/java.nio.charset=ALL-UNNAMED --add-opens=java.base/java.net=ALL-UNNAMED --add-opens=java.base/java.util.concurrent.atomic=ALL-UNNAMED -Xmx2500m -Dfile.encoding=UTF-8 -Djava.io.tmpdir=C:\\tcagent1\\temp\\buildTmp -Duser.country=US -Duser.language=en -Duser.variant -cp C:\\Users\\tcagent1\\.gradle\\wrapper\\dists\\gradle-7.6-20220806221607+0000-bin\\bahzw6xytyvv1efgmigua9ttp\\gradle-7.6-20220806221607+0000\\lib\\gradle-launcher-7.6.jar org.gradle.launcher.daemon.bootstrap.GradleDaemon 7.6-20220806221607+0000  11084

C:\\Windows\\system32\\cmd.exe /c C:\\tcagent1\\work\\f63322e10dd6b396\\gradlew.bat --init-script C:\\tcagent1\\plugins\\gradle-runner\\scripts\\init.gradle --init-script C:\\tcagent1\\temp\\agentTmp\\build-scan-init.gradle -Dorg.gradle.workers.max=4 -PmaxParallelForks=4 -Dorg.gradle.internal.plugins.portal.url.override=https://repo.grdev.net/artifactory/gradle-plugin-portal-prod/ -s --no-configuration-cache --daemon --continue -PtestJavaVersion=8 -PtestJavaVendor=openjdk -Dscan.tag.FunctionalTest -Dscan.value.coverageOs=windows -Dscan.value.coverageArch=amd64 -Dscan.value.coverageJvmVendor=openjdk -Dscan.value.coverageJvmVersion=java8 -PflakyTests=include -Dscan.tag.Check -Dscan.tag.ReadyforRelease -PteamCityBuildId=54978386 "-Porg.gradle.java.installations.paths=C:\\Program Files\\Java\\open-jdk-8,C:\\Program Files\\Java\\open-jdk-11,C:\\Program Files\\Java\\open-jdk-17,C:\\Program Files\\Java\\open-jdk-18,C:\\Program Files\\Java\\open-jdk-8" -Porg.gradle.java.installations.auto-download=false clean code-quality:allVersionsIntegMultiVersionTest wrapper-shared:allVersionsIntegMultiVersionTest wrapper:allVersionsIntegMultiVersionTest workers:allVersionsIntegMultiVersionTest version-control:allVersionsIntegMultiVersionTest tooling-api:allVersionsIntegMultiVersionTest testing-base:allVersionsIntegMultiVersionTest snapshots:allVersionsIntegMultiVersionTest signing:allVersionsIntegMultiVersionTest samples:allVersionsIntegMultiVersionTest resources-sftp:allVersionsIntegMultiVersionTest file-watching:allVersionsIntegMultiVersionTest  9404
"C:\\Program Files\\Java\\open-jdk-11/bin/java.exe" -Dfile.encoding=UTF-8 "-Xmx64m" "-Xms64m" -Xmx1536m -XX:MaxPermSize=384m "-Djava.io.tmpdir=C:\\tcagent1\\temp\\buildTmp" "-Dorg.gradle.appname=gradlew" -classpath "C:\\tcagent1\\work\\f63322e10dd6b396\\\\gradle\\wrapper\\gradle-wrapper.jar" org.gradle.wrapper.GradleWrapperMain --init-script C:\\tcagent1\\plugins\\gradle-runner\\scripts\\init.gradle --init-script C:\\tcagent1\\temp\\agentTmp\\build-scan-init.gradle -Dorg.gradle.workers.max=4 -PmaxParallelForks=4 -Dorg.gradle.internal.plugins.portal.url.override=https://repo.grdev.net/artifactory/gradle-plugin-portal-prod/ -s --no-configuration-cache --daemon --continue -PtestJavaVersion=8 -PtestJavaVendor=openjdk -Dscan.tag.FunctionalTest -Dscan.value.coverageOs=windows -Dscan.value.coverageArch=amd64 -Dscan.value.coverageJvmVendor=openjdk -Dscan.value.coverageJvmVersion=java8 -PflakyTests=include -Dscan.tag.Check -Dscan.tag.ReadyforRelease -PteamCityBuildId=54978386 "-Porg.gradle.java.installations.paths=C:\\Program Files\\Java\\open-jdk-8,C:\\Program Files\\Java\\open-jdk-11,C:\\Program Files\\Java\\open-jdk-17,C:\\Program Files\\Java\\open-jdk-18,C:\\Program Files\\Java\\open-jdk-8" -Porg.gradle.java.installations.auto-download=false clean code-quality:allVersionsIntegMultiVersionTest wrapper-shared:allVersionsIntegMultiVersionTest wrapper:allVersionsIntegMultiVersionTest workers:allVersionsIntegMultiVersionTest version-control:allVersionsIntegMultiVersionTest tooling-api:allVersionsIntegMultiVersionTest testing-base:allVersionsIntegMultiVersionTest snapshots:allVersionsIntegMultiVersionTest signing:allVersionsIntegMultiVersionTest samples:allVersionsIntegMultiVersionTest resources-sftp:allVersionsIntegMultiVersionTest file-watching:allVersionsIntegMultiVersionTest  8476

"C:\\Program Files\\Java\\open-jdk-8\\bin\\java.exe" -Dinclude.spock.annotation=org.gradle.integtests.fixtures.compatibility.MultiVersionTestCategory -DintegTest.distZipVersion=7.7-20220815220100+0000 "-DintegTest.gradleHomeDir=C:\\tcagent1\\work\\f63322e10dd6b396\\subprojects\\distributions-full\\build\\bin distribution" -DintegTest.gradleUserHomeDir=C:\\tcagent1\\work\\f63322e10dd6b396\\intTestHomeDir\\distributions-full -DintegTest.samplesdir=C:\\tcagent1\\work\\f63322e10dd6b396\\subprojects\\docs\\src\\snippets -Djava.security.manager=worker.org.gradle.process.internal.worker.child.BootstrapSecurityManager -Dorg.gradle.ci.agentCount=2 -Dorg.gradle.ci.agentNum=1 -Dorg.gradle.integtest.daemon.registry=C:\\tcagent1\\work\\f63322e10dd6b396\\build\\daemon\\distributions-full -Dorg.gradle.integtest.executer=forking -Dorg.gradle.integtest.mirrors.google=https://repo.grdev.net/artifactory/google -Dorg.gradle.integtest.mirrors.gradle-dev-plugins=https://repo.grdev.net/artifactory/gradle-plugin-portal-dev/ -Dorg.gradle.integtest.mirrors.gradle-enterprise-rc=https://repo.grdev.net/artifactory/enterprise-libs-release-candidates-local/ -Dorg.gradle.integtest.mirrors.gradle-prod-plugins=https://repo.grdev.net/artifactory/gradle-plugin-portal-prod/ -Dorg.gradle.integtest.mirrors.gradle-public=https://repo.grdev.net/artifactory/public/ -Dorg.gradle.integtest.mirrors.internal-ci-mirror=https://repo.grdev.net/artifactory/internal-ci-mirror -Dorg.gradle.integtest.mirrors.jcenter=https://repo.grdev.net/artifactory/jcenter -Dorg.gradle.integtest.mirrors.jenkins=https://repo.grdev.net/artifactory/jenkins/ -Dorg.gradle.integtest.mirrors.jitpack=https://repo.grdev.net/artifactory/jitpack/ -Dorg.gradle.integtest.mirrors.kotlineap=https://repo.grdev.net/artifactory/kotlin-eap/ -Dorg.gradle.integtest.mirrors.mavencentral=https://repo.grdev.net/artifactory/maven-central/ -Dorg.gradle.integtest.mirrors.oss-snapshot=https://repo.grdev.net/artifactory/jfrog-oss-snapshot -Dorg.gradle.integtest.mirrors.springreleases=https://repo.grdev.net/artifactory/springreleases -Dorg.gradle.integtest.mirrors.springsnapshots=https://repo.grdev.net/artifactory/spring-snapshots -Dorg.gradle.integtest.versions=all -Dorg.gradle.internal.worker.tmpdir=C:\\tcagent1\\work\\f63322e10dd6b396\\subprojects\\code-quality\\build\\tmp\\integMultiVersionTest\\work -Dorg.gradle.native=false -Dorg.gradle.test.maxParallelForks=8 -Dspock.configuration=GradleBuildSpockConfig.groovy -XX:+HeapDumpOnOutOfMemoryError -Xmx512m -Dfile.encoding=UTF-8 -Duser.country=US -Duser.language=en -Duser.variant -ea -cp C:\\Users\\tcagent1\\.gradle\\caches\\7.6-20220806221607+0000\\workerMain\\gradle-worker.jar worker.org.gradle.process.internal.worker.GradleWorkerMain "'Gradle Test Executor 218'" 9916

"C:\\Program Files\\Java\\open-jdk-8\\bin\\java.exe" -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=C:\\tcagent1\\work\\f63322e10dd6b396\\intTestHomeDir\\distributions-full -Xms256m -Xmx1024m -Dfile.encoding=UTF-8 -Djava.io.tmpdir=C:\\tcagent1\\work\\f63322e10dd6b396\\subprojects\\code-quality\\build\\tmp -Duser.country=US -Duser.language=en -Duser.variant -ea -cp "C:\\tcagent1\\work\\f63322e10dd6b396\\subprojects\\distributions-full\\build\\bin distribution\\lib\\gradle-launcher-7.7.jar" org.gradle.launcher.daemon.bootstrap.GradleDaemon 7.7-20220815220100+0000  396

"C:\\Program Files\\Java\\open-jdk-15\\bin\\java.exe" --add-opens=java.base/java.util=ALL-UNNAMED --add-opens=java.base/java.lang=ALL-UNNAMED @C:\\tcagent1\\work\\f63322e10dd6b396\\intTestHomeDir\\distributions-full\\.tmp\\gradle-worker-classpath3936353344673416185txt -Xmx512m -Dfile.encoding=UTF-8 -Duser.country=US -Duser.language=en -Duser.variant worker.org.gradle.process.internal.worker.GradleWorkerMain "'Gradle Worker Daemon 3'"  1948
"""

    def 'windows test'() {
        List<KillLeakingJavaProcesses.JavaProcessInfo> javaProcesses = KillLeakingJavaProcesses.JavaProcessInfo.parsePsOutput(windowsPsOutput, true)

        expect:
        javaProcesses.collect { it.pid } == ["10124", "11084", "8476", "9916", "396", "1948"]
        javaProcesses.collect { it.mainClass } == [
            null,
            "org.gradle.launcher.daemon.bootstrap.GradleDaemon",
            "org.gradle.wrapper.GradleWrapperMain",
            "worker.org.gradle.process.internal.worker.GradleWorkerMain",
            "org.gradle.launcher.daemon.bootstrap.GradleDaemon",
            "worker.org.gradle.process.internal.worker.GradleWorkerMain"
        ]
        javaProcesses.collect { it.classpath } == [
            "C:\\tcagent1\\lib\\agent-configurator.jar;C:\\tcagent1\\lib\\agent-installer-ui.jar;C:\\tcagent1\\lib\\agent-launcher.jar;C:\\tcagent1\\lib\\agent-openapi.jar;C:\\tcagent1\\lib\\agent-upgrade.jar;C:\\tcagent1\\lib\\agent.jar;C:\\tcagent1\\lib\\annotations.jar;C:\\tcagent1\\lib\\app-wrapper.jar;C:\\tcagent1\\lib\\buildAgent-updates-applying.jar;C:\\tcagent1\\lib\\cloud-shared.jar;C:\\tcagent1\\lib\\common-impl.jar;C:\\tcagent1\\lib\\common-runtime.jar;C:\\tcagent1\\lib\\common.jar;C:\\tcagent1\\lib\\commons-beanutils-core.jar;C:\\tcagent1\\lib\\commons-codec.jar;C:\\tcagent1\\lib\\commons-collections-3.2.2.jar;C:\\tcagent1\\lib\\commons-compress-1.21.jar;C:\\tcagent1\\lib\\commons-httpclient-3.1.jar;C:\\tcagent1\\lib\\commons-io-1.3.2.jar;C:\\tcagent1\\lib\\commons-logging.jar;C:\\tcagent1\\lib\\coverage-agent-common.jar;C:\\tcagent1\\lib\\coverage-report-1.0.jar;C:\\tcagent1\\lib\\duplicator-util.jar;C:\\tcagent1\\lib\\ehcache-1.6.0-patch.jar;C:\\tcagent1\\lib\\ehcache-1.7.2.jar;C:\\tcagent1\\lib\\freemarker.jar;C:\\tcagent1\\lib\\gson-2.8.9.jar;C:\\tcagent1\\lib\\idea-settings.jar;C:\\tcagent1\\lib\\inspections-util.jar;C:\\tcagent1\\lib\\jackson-annotations.jar;C:\\tcagent1\\lib\\jackson-core.jar;C:\\tcagent1\\lib\\jackson-databind.jar;C:\\tcagent1\\lib\\jackson-dataformat-xml.jar;C:\\tcagent1\\lib\\jackson-dataformat-yaml.jar;C:\\tcagent1\\lib\\jackson-datatype-jdk8.jar;C:\\tcagent1\\lib\\jackson-datatype-jsr310.jar;C:\\tcagent1\\lib\\jackson-module-jaxb-annotations.jar;C:\\tcagent1\\lib\\jackson-module-parameter-names.jar;C:\\tcagent1\\lib\\jakarta.xml.bind-api.jar;C:\\tcagent1\\lib\\jaxen-1.1.1.jar;C:\\tcagent1\\lib\\jdk-searcher.jar;C:\\tcagent1\\lib\\jdom.jar;C:\\tcagent1\\lib\\joda-time.jar;C:\\tcagent1\\lib\\launcher-api.jar;C:\\tcagent1\\lib\\launcher.jar;C:\\tcagent1\\lib\\log4j-1.2-api-2.17.2.jar;C:\\tcagent1\\lib\\log4j-1.2.12-json-layout.jar;C:\\tcagent1\\lib\\log4j-api-2.17.2.jar;C:\\tcagent1\\lib\\log4j-core-2.17.2.jar;C:\\tcagent1\\lib\\logging.jar;C:\\tcagent1\\lib\\messages.jar;C:\\tcagent1\\lib\\nuget-utils.jar;C:\\tcagent1\\lib\\oauth-integration-agent.jar;C:\\tcagent1\\lib\\openapi.jar;C:\\tcagent1\\lib\\patches-impl.jar;C:\\tcagent1\\lib\\patches.jar;C:\\tcagent1\\lib\\resources_en.jar;C:\\tcagent1\\lib\\runtime-util.jar;C:\\tcagent1\\lib\\server-logging.jar;C:\\tcagent1\\lib\\serviceMessages.jar;C:\\tcagent1\\lib\\slf4j-api-1.7.32.jar;C:\\tcagent1\\lib\\slf4j-log4j12-1.7.32.jar;C:\\tcagent1\\lib\\snakeyaml.jar;C:\\tcagent1\\lib\\spring-scripting\\spring-scripting-bsh.jar;C:\\tcagent1\\lib\\spring-scripting\\spring-scripting-groovy.jar;C:\\tcagent1\\lib\\spring-scripting\\spring-scripting-jruby.jar;C:\\tcagent1\\lib\\spring.jar;C:\\tcagent1\\lib\\stax2-api.jar;C:\\tcagent1\\lib\\trove-3.0.3.jar;C:\\tcagent1\\lib\\trove4j.jar;C:\\tcagent1\\lib\\util.jar;C:\\tcagent1\\lib\\woodstox-core.jar;C:\\tcagent1\\lib\\xercesImpl.jar;C:\\tcagent1\\lib\\xml-apis-1.4.01.jar;C:\\tcagent1\\lib\\xml-rpc-wrapper.jar;C:\\tcagent1\\lib\\xmlrpc-2.0.1.jar;C:\\tcagent1\\lib\\xpp3-1.1.4c.jar;C:\\tcagent1\\lib\\xstream-1.4.11.1-custom.jar;C:\\tcagent1\\lib\\xz-1.8.jar",
            "C:\\Users\\tcagent1\\.gradle\\wrapper\\dists\\gradle-7.6-20220806221607+0000-bin\\bahzw6xytyvv1efgmigua9ttp\\gradle-7.6-20220806221607+0000\\lib\\gradle-launcher-7.6.jar",
            "C:\\tcagent1\\work\\f63322e10dd6b396\\\\gradle\\wrapper\\gradle-wrapper.jar",
            "C:\\Users\\tcagent1\\.gradle\\caches\\7.6-20220806221607+0000\\workerMain\\gradle-worker.jar",
            "C:\\tcagent1\\work\\f63322e10dd6b396\\subprojects\\distributions-full\\build\\bin",
            null
        ]
    }

    def 'unix test'() {
        List<KillLeakingJavaProcesses.JavaProcessInfo> javaProcesses = KillLeakingJavaProcesses.JavaProcessInfo.parsePsOutput(unixPsOutput, false)

        expect:
        javaProcesses.collect { it.pid } == ["576321", "591686", "841959", "842155", "1682545", "1682568"]
        javaProcesses.collect { it.mainClass } == [
            "org.gradle.launcher.daemon.bootstrap.GradleDaemon",
            "org.gradle.launcher.daemon.bootstrap.GradleDaemon",
            "org.gradle.wrapper.GradleWrapperMain",
            "worker.org.gradle.process.internal.worker.GradleWorkerMain",
            null,
            null
        ]

        javaProcesses.collect { it.classpath } == [
            "/home/tcagent1/.gradle/wrapper/dists/gradle-7.6-20220806221607+0000-bin/bahzw6xytyvv1efgmigua9ttp/gradle-7.6-20220806221607+0000/lib/gradle-launcher-7.6.jar",
            "/home/tcagent1/.gradle/wrapper/dists/gradle-7.6-20220727112213+0000-bin/ogbl2n2fcv4m7e8tuoxs96sx/gradle-7.6-20220727112213+0000/lib/gradle-launcher-7.6.jar",
            "/home/tcagent1/agent/work/469d486140ba335/gradle/wrapper/gradle-wrapper.jar",
            "/home/tcagent1/.gradle/caches/6.9.2/workerMain/gradle-worker.jar",
            "../launcher/lib/launcher.jar",
            "/home/tcagent1/agent/lib/jdom.jar:/home/tcagent1/agent/lib/launcher.jar:/home/tcagent1/agent/lib/server-logging.jar:/home/tcagent1/agent/lib/jakarta.xml.bind-api.jar:/home/tcagent1/agent/lib/agent-installer-ui.jar:/home/tcagent1/agent/lib/xmlrpc-2.0.1.jar:/home/tcagent1/agent/lib/ehcache-1.7.2.jar:/home/tcagent1/agent/lib/agent-configurator.jar:/home/tcagent1/agent/lib/cloud-shared.jar:/home/tcagent1/agent/lib/woodstox-core.jar:/home/tcagent1/agent/lib/common-runtime.jar:/home/tcagent1/agent/lib/jackson-module-parameter-names.jar:/home/tcagent1/agent/lib/freemarker.jar:/home/tcagent1/agent/lib/joda-time.jar:/home/tcagent1/agent/lib/patches.jar:/home/tcagent1/agent/lib/spring-scripting/spring-scripting-groovy.jar:/home/tcagent1/agent/lib/spring-scripting/spring-scripting-jruby.jar:/home/tcagent1/agent/lib/spring-scripting/spring-scripting-bsh.jar:/home/tcagent1/agent/lib/commons-collections-3.2.2.jar:/home/tcagent1/agent/lib/slf4j-log4j12-1.7.32.jar:/home/tcagent1/agent/lib/jaxen-1.1.1.jar:/home/tcagent1/agent/lib/stax2-api.jar:/home/tcagent1/agent/lib/xml-apis-1.4.01.jar:/home/tcagent1/agent/lib/openapi.jar:/home/tcagent1/agent/lib/commons-codec.jar:/home/tcagent1/agent/lib/jackson-databind.jar:/home/tcagent1/agent/lib/jackson-module-jaxb-annotations.jar:/home/tcagent1/agent/lib/util.jar:/home/tcagent1/agent/lib/agent-openapi.jar:/home/tcagent1/agent/lib/spring.jar:/home/tcagent1/agent/lib/logging.jar:/home/tcagent1/agent/lib/log4j-api-2.17.2.jar:/home/tcagent1/agent/lib/duplicator-util.jar:/home/tcagent1/agent/lib/patches-impl.jar:/home/tcagent1/agent/lib/buildAgent-updates-applying.jar:/home/tcagent1/agent/lib/xz-1.8.jar:/home/tcagent1/agent/lib/common-impl.jar:/home/tcagent1/agent/lib/snakeyaml.jar:/home/tcagent1/agent/lib/jackson-dataformat-xml.jar:/home/tcagent1/agent/lib/jackson-datatype-jsr310.jar:/home/tcagent1/agent/lib/idea-settings.jar:/home/tcagent1/agent/lib/slf4j-api-1.7.32.jar:/home/tcagent1/agent/lib/messages.jar:/home/tcagent1/agent/lib/jdk-searcher.jar:/home/tcagent1/agent/lib/trove-3.0.3.jar:/home/tcagent1/agent/lib/agent.jar:/home/tcagent1/agent/lib/annotations.jar:/home/tcagent1/agent/lib/log4j-core-2.17.2.jar:/home/tcagent1/agent/lib/gson-2.8.9.jar:/home/tcagent1/agent/lib/coverage-agent-common.jar:/home/tcagent1/agent/lib/common.jar:/home/tcagent1/agent/lib/launcher-api.jar:/home/tcagent1/agent/lib/xstream-1.4.11.1-custom.jar:/home/tcagent1/agent/lib/ehcache-1.6.0-patch.jar:/home/tcagent1/agent/lib/jackson-annotations.jar:/home/tcagent1/agent/lib/jackson-dataformat-yaml.jar:/home/tcagent1/agent/lib/commons-io-1.3.2.jar:/home/tcagent1/agent/lib/agent-upgrade.jar:/home/tcagent1/agent/lib/jackson-datatype-jdk8.jar:/home/tcagent1/agent/lib/serviceMessages.jar:/home/tcagent1/agent/lib/coverage-report-1.0.jar:/home/tcagent1/agent/lib/agent-launcher.jar:/home/tcagent1/agent/lib/log4j-1.2.12-json-layout.jar:/home/tcagent1/agent/lib/xercesImpl.jar:/home/tcagent1/agent/lib/oauth-integration-agent.jar:/home/tcagent1/agent/lib/commons-logging.jar:/home/tcagent1/agent/lib/runtime-util.jar:/home/tcagent1/agent/lib/commons-httpclient-3.1.jar:/home/tcagent1/agent/lib/trove4j.jar:/home/tcagent1/agent/lib/commons-beanutils-core.jar:/home/tcagent1/agent/lib/inspections-util.jar:/home/tcagent1/agent/lib/nuget-utils.jar:/home/tcagent1/agent/lib/log4j-1.2-api-2.17.2.jar:/home/tcagent1/agent/lib/app-wrapper.jar:/home/tcagent1/agent/lib/commons-compress-1.21.jar:/home/tcagent1/agent/lib/xml-rpc-wrapper.jar:/home/tcagent1/agent/lib/resources_en.jar:/home/tcagent1/agent/lib/xpp3-1.1.4c.jar:/home/tcagent1/agent/lib/jackson-core.jar"
        ]
    }
}
